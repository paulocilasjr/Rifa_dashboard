{% extends 'base.html' %}

{% block content %}
  <section class="card">
    <div class="section-header">
      <h1>Log de Auditoria</h1>
      <a class="btn" href="{{ url_for('admin_dashboard') }}">Voltar ao Painel</a>
    </div>

    <form method="get" class="form filter-grid">
      <label class="field">
        <span>Ação</span>
        <select name="action">
          <option value="">Qualquer</option>
          {% for item in actions %}
            <option value="{{ item.action }}" {% if item.action == action %}selected{% endif %}>{{ item.action }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Ator</span>
        <select name="actor">
          <option value="">Qualquer</option>
          {% for user in users %}
            <option value="{{ user.username }}" {% if user.username == actor %}selected{% endif %}>{{ user.username }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Vendedor</span>
        <select name="seller">
          <option value="">Qualquer</option>
          {% for user in users %}
            <option value="{{ user.username }}" {% if user.username == seller %}selected{% endif %}>{{ user.username }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Número</span>
        <input type="number" name="number" min="1" max="{{ max_number }}" value="{{ number or '' }}" placeholder="ex.: 1200">
      </label>
      <label class="field">
        <span>Data Início (UTC)</span>
        <input type="text" name="date_from" value="{{ date_from }}" placeholder="AAAA-MM-DD">
      </label>
      <label class="field">
        <span>Data Fim (UTC)</span>
        <input type="text" name="date_to" value="{{ date_to }}" placeholder="AAAA-MM-DD">
      </label>
      <div class="form-actions">
        <button type="submit" class="btn primary">Aplicar Filtros</button>
        <a class="btn" href="{{ url_for('admin_audit') }}">Limpar</a>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>Resultados</h2>
      <div class="small">Total: {{ total }} | Página {{ page }} de {{ page_count }}</div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Ação</th>
          <th>Número</th>
          <th>Ator</th>
          <th>Vendedor</th>
          <th>Hora (UTC)</th>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <td>{{ row.action }}</td>
            <td>{{ row.number or '-' }}</td>
            <td>{{ row.actor_username or '-' }}</td>
            <td>{{ row.seller_username or '-' }}</td>
            <td>{{ row.created_at }}</td>
            <td>
              {% if row.details %}
                <details>
                  <summary>Ver</summary>
                  <pre class="code-block">{{ row.details }}</pre>
                </details>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6">Nenhum registro encontrado.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="page-controls">
      <a class="btn" href="{{ url_for('admin_audit', page=1, **filters) }}">Primeira</a>
      <a class="btn" href="{{ url_for('admin_audit', page=page-1 if page > 1 else 1, **filters) }}">Anterior</a>
      <span>Página {{ page }} de {{ page_count }}</span>
      <a class="btn" href="{{ url_for('admin_audit', page=page+1 if page < page_count else page_count, **filters) }}">Próxima</a>
      <a class="btn" href="{{ url_for('admin_audit', page=page_count, **filters) }}">Última</a>
    </div>
  </section>
{% endblock %}

{% extends 'base.html' %}

{% block content %}
  <section class="card stat-card">
    <h1>Painel do Superusuário</h1>
    <div class="stats">
      <div>
        <div class="stat-label">Total Vendido</div>
        <div class="stat-value">{{ total_sold }}</div>
      </div>
      <div>
        <div class="stat-label">Reservado</div>
        <div class="stat-value">{{ total_reserved }}</div>
      </div>
      <div>
        <div class="stat-label">Restante</div>
        <div class="stat-value">{{ total_remaining }}</div>
      </div>
    </div>
    <div class="form-actions" style="margin-top: 12px;">
      <a class="btn" href="{{ url_for('export_sales') }}">Baixar Vendas (CSV)</a>
    </div>
  </section>

  <section class="card">
    <h2>Buscar Número</h2>
    <form method="get" class="form inline-form">
      <label class="field">
        <span>Número</span>
        <input type="number" name="number" min="1" max="{{ max_number }}" placeholder="ex.: 1200">
      </label>
      <button type="submit" class="btn">Buscar</button>
    </form>

    {% if search_sale %}
      {% if search_sale.not_found %}
        <div class="search-result">Número {{ search_sale.number }} está disponível.</div>
      {% elif search_sale.status == 'reserved' %}
        <div class="search-result">
          <strong>Número {{ search_sale.number }}</strong>
          <span class="pill reserved">Reservado</span>
          <div class="small">Reservado por: {{ search_sale.seller_username }}</div>
          <div class="small">Reservado até: {{ search_sale.reserved_until }}</div>
          <form method="post" action="{{ url_for('release_reservation', number=search_sale.number) }}" class="inline-form">
            <button type="submit" class="btn">Liberar Reserva</button>
          </form>
        </div>
      {% else %}
        <div class="search-result">
          <strong>Número {{ search_sale.number }}</strong>
          <span class="pill sold">Vendido</span>
          <div class="small">Vendedor: {{ search_sale.seller_username }}</div>
          <div class="small">Comprador: {{ search_sale.buyer_name }} | Telefone: {{ search_sale.buyer_phone }}</div>
          <div class="small">Vendido em: {{ search_sale.sold_at }}</div>
          <form method="post" action="{{ url_for('edit_sale', number=search_sale.number) }}" class="inline-form">
            <input type="text" name="buyer_name" placeholder="Nome do comprador" required>
            <input type="text" name="buyer_phone" placeholder="Telefone do comprador" required>
            <button type="submit" class="btn">Editar Venda</button>
          </form>
          <button
            type="button"
            class="btn danger js-confirm"
            data-confirm-action="{{ url_for('void_sale', number=search_sale.number) }}"
            data-confirm-title="Cancelar venda"
            data-confirm-message="Deseja cancelar a venda do número {{ search_sale.number }}?"
            data-confirm-submit="Cancelar venda"
          >
            Cancelar Venda
          </button>
        </div>
      {% endif %}
    {% endif %}
  </section>

  <section class="card">
    <div class="section-header">
      <h2>Desempenho dos Vendedores</h2>
      <a class="btn" href="{{ url_for('admin_users') }}">Gerenciar Vendedores</a>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Vendedor</th>
          <th>Números Vendidos</th>
        </tr>
      </thead>
      <tbody>
        {% for seller in seller_stats %}
          <tr>
            <td>{{ seller.username }}</td>
            <td>{{ seller.sold_count }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="2">Nenhum vendedor ainda.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <h2>Vendas Recentes</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Vendedor</th>
          <th>Comprador</th>
          <th>Telefone</th>
          <th>Vendido em</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in recent_sales %}
          <tr>
            <td>{{ sale.number }}</td>
            <td>{{ sale.seller_username }}</td>
            <td>{{ sale.buyer_name }}</td>
            <td>{{ sale.buyer_phone }}</td>
            <td>{{ sale.sold_at }}</td>
            <td>
              <button
                type="button"
                class="btn danger js-confirm"
                data-confirm-action="{{ url_for('void_sale', number=sale.number) }}"
                data-confirm-title="Excluir venda"
                data-confirm-message="Deseja excluir a venda do número {{ sale.number }}?"
                data-confirm-submit="Excluir"
              >
                Excluir
              </button>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="6">Nenhuma venda ainda.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="card">
    <div class="section-header">
      <h2>Log de Auditoria Recentes</h2>
      <a class="btn" href="{{ url_for('admin_audit') }}">Log Completo</a>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>Ação</th>
          <th>Número</th>
          <th>Ator</th>
          <th>Hora (UTC)</th>
        </tr>
      </thead>
      <tbody>
        {% for item in recent_audit %}
          <tr>
            <td>{{ item.action }}</td>
            <td>{{ item.number or '-' }}</td>
            <td>{{ item.actor_username or 'sistema' }}</td>
            <td>{{ item.created_at }}</td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4">Nenhuma auditoria ainda.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}

{% extends 'base.html' %}

{% block content %}
  <section class="card stat-card">
    <h1>Painel do Vendedor</h1>
    <div class="stats">
      <div>
        <div class="stat-label">Total Vendido</div>
        <div class="stat-value">{{ total_sold }}</div>
      </div>
      <div>
        <div class="stat-label">Reservas Ativas</div>
        <div class="stat-value">{{ total_reserved }}</div>
      </div>
      <div>
        <div class="stat-label">Intervalo Atual</div>
        <div class="stat-value">{{ start }} - {{ end }}</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Buscar Número</h2>
    <form method="get" class="form inline-form">
      <label class="field">
        <span>Número (1 - {{ max_number }})</span>
        <input type="number" name="number" min="1" max="{{ max_number }}" placeholder="Buscar por número">
      </label>
      <button type="submit" class="btn">Buscar</button>
    </form>

    {% if search_result %}
      <div class="search-result">
        <strong>Número {{ search_result.number }}</strong>
        {% if search_result.status == 'sold' %}
          <span class="pill sold">Vendido</span>
          <div class="small">Comprador: {{ search_result.buyer_name }} | Telefone: {{ search_result.buyer_phone }}</div>
          <div class="small">Vendido em: {{ search_result.sold_at }}</div>
          {% if search_result.can_edit %}
            <form method="post" action="{{ url_for('edit_sale', number=search_result.number) }}" class="inline-form">
              <input type="text" name="buyer_name" placeholder="Nome do comprador" required>
              <input type="text" name="buyer_phone" placeholder="Telefone do comprador" required>
              <button type="submit" class="btn">Editar Venda</button>
            </form>
            <button
              type="button"
              class="btn danger js-confirm"
              data-confirm-action="{{ url_for('void_sale', number=search_result.number) }}"
              data-confirm-title="Cancelar venda"
              data-confirm-message="Deseja cancelar a venda do número {{ search_result.number }}?"
              data-confirm-submit="Cancelar venda"
            >
              Cancelar Venda
            </button>
          {% endif %}
        {% elif search_result.status == 'reserved' %}
          <span class="pill reserved">Reservado</span>
          {% if search_result.reserved_by_me %}
            <div class="small">Reservado por você até {{ search_result.reserved_until }}</div>
            <label class="search-select">
              <input
                type="checkbox"
                class="js-select-number"
                data-number="{{ search_result.number }}"
                data-selectable="true"
              >
              <span>Adicionar à seleção</span>
            </label>
          {% else %}
            <div class="small">Reservado por outro vendedor até {{ search_result.reserved_until }}</div>
          {% endif %}
        {% else %}
          <span class="pill available">Disponível</span>
          <label class="search-select">
            <input
              type="checkbox"
              class="js-select-number"
              data-number="{{ search_result.number }}"
              data-selectable="true"
            >
            <span>Adicionar à seleção</span>
          </label>
        {% endif %}
      </div>
    {% endif %}
  </section>

  <section class="card">
    <h2>Selecionar Números para Reservar ou Vender</h2>
    <div class="page-controls">
      <a class="btn" href="{{ url_for('seller_dashboard', page=1) }}">Primeira</a>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page-1 if page > 1 else 1) }}">Anterior</a>
      <span>Página {{ page }} de {{ page_count }}</span>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page+1 if page < page_count else page_count) }}">Próxima</a>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page_count) }}">Última</a>
    </div>

    <form method="post" class="form" id="numbers-form">
      <div class="numbers-grid">
        {% for item in numbers %}
          <label class="number-item
            {% if item.sold %}is-sold{% endif %}
            {% if item.reserved_by_other %}is-reserved{% endif %}
            {% if item.reserved_by_me %}is-reserved-me{% endif %}
          ">
            <input
              type="checkbox"
              name="numbers"
              value="{{ item.number }}"
              {% if item.sold or item.reserved_by_other %}disabled{% endif %}
            >
            <span>{{ item.number }}</span>
          </label>
        {% endfor %}
      </div>

      <div class="selection-summary">
        <span>Selecionados: <strong id="selected-count">0</strong></span>
        <span id="selected-preview" class="small"></span>
        <button type="button" class="btn" id="clear-selection-btn">Limpar seleção</button>
      </div>

      <div class="buyer-fields">
        <label class="field">
          <span>Nome do Comprador (obrigatório para vender)</span>
          <input type="text" name="buyer_name">
        </label>
        <label class="field">
          <span>Telefone do Comprador (obrigatório para vender)</span>
          <input type="text" name="buyer_phone">
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" name="action" value="reserve" class="btn">Reservar</button>
        <button type="submit" name="action" value="sell" class="btn primary">Confirmar Venda</button>
      </div>
      <div class="small">Reservas duram {{ reserve_minutes }} minutos e impedem que outros vendedores vendam os mesmos números.</div>
    </form>
  </section>

  <section class="card">
    <h2>Suas Reservas Ativas</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Reservado Até (UTC)</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        {% for reservation in my_reservations %}
          <tr>
            <td>{{ reservation.number }}</td>
            <td>{{ reservation.reserved_until }}</td>
            <td>
              <form method="post" action="{{ url_for('release_reservation', number=reservation.number) }}">
                <button type="submit" class="btn">Liberar</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="3">Nenhuma reserva ativa.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}

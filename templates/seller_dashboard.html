{% extends 'base.html' %}

{% block content %}
  <section class="card stat-card">
    <h1>Painel do Vendedor</h1>
    <div class="stats">
      <div>
        <div class="stat-label">Total Vendido</div>
        <div class="stat-value">{{ total_sold }}</div>
      </div>
      <div>
        <div class="stat-label">Reservas Ativas</div>
        <div class="stat-value">{{ total_reserved }}</div>
      </div>
      <div>
        <div class="stat-label">Intervalo</div>
        <div class="stat-value">{{ start }} - {{ end }}</div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Buscar Número</h2>
    <div class="form inline-form">
      <label class="field">
        <span>Número (1 - {{ max_number }})</span>
        <input
          type="number"
          id="search-number-input"
          min="1"
          max="{{ max_number }}"
          data-page-size="{{ page_size }}"
          data-page-count="{{ page_count }}"
          placeholder="Buscar por número"
        >
      </label>
      <button type="button" class="btn" id="search-number-btn">Buscar</button>
    </div>

    <div class="search-result" id="search-result" hidden>
      <div class="search-result-header">
        <div class="search-result-title">
          <strong id="search-result-number"></strong>
          <span class="pill" id="search-result-pill"></span>
        </div>
        <button
          type="button"
          class="btn js-select-number"
          id="search-select-btn"
          data-number=""
          data-selectable="false"
          disabled
        >
          Selecionar numero
        </button>
      </div>
      <div class="small" id="search-result-note"></div>
    </div>
  </section>

  <section class="card">
    <h2>Selecionar Números para Reservar ou Vender</h2>
    <div class="page-controls">
      <a class="btn" href="{{ url_for('seller_dashboard', page=1) }}">Primeira</a>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page-1 if page > 1 else 1) }}">Anterior</a>
      <span>Página {{ page }} de {{ page_count }}</span>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page+1 if page < page_count else page_count) }}">Próxima</a>
      <a class="btn" href="{{ url_for('seller_dashboard', page=page_count) }}">Última</a>
    </div>
    <div class="form inline-form">
      <label class="field">
        <span>Buscar número</span>
        <input
          type="number"
          id="number-filter"
          min="1"
          max="{{ max_number }}"
          placeholder="Digite para filtrar"
        >
      </label>
    </div>

    <form method="post" class="form" id="numbers-form">
      <div class="numbers-grid">
        {% for item in numbers %}
          <label class="number-item
            {% if item.sold %}is-sold{% endif %}
            {% if item.reserved_by_other %}is-reserved{% endif %}
            {% if item.reserved_by_me %}is-reserved-me{% endif %}
          " data-number="{{ item.number }}">
            <input
              type="checkbox"
              name="numbers"
              value="{{ item.number }}"
              {% if item.sold or item.reserved_by_other %}disabled{% endif %}
            >
            <span>{{ item.number }}</span>
          </label>
        {% endfor %}
      </div>

      <div class="selection-summary">
        <span>Selecionados: <strong id="selected-count">0</strong></span>
        <span id="selected-preview" class="small"></span>
        <button type="button" class="btn" id="clear-selection-btn" data-clear-selection="1">
          Deletar selecao
        </button>
      </div>

      <div class="buyer-fields">
        <label class="field">
          <span>Nome do Comprador (obrigatório para vender)</span>
          <input type="text" name="buyer_name">
        </label>
        <label class="field">
          <span>Telefone do Comprador (obrigatório para vender)</span>
          <input type="text" name="buyer_phone">
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" name="action" value="reserve" class="btn">Reservar</button>
        <button type="submit" name="action" value="sell" class="btn primary">Confirmar Venda</button>
      </div>
      <div class="small">Reservas duram {{ reserve_minutes }} minutos e impedem que outros vendedores vendam os mesmos números.</div>
    </form>
  </section>

  <section class="card">
    <h2>Suas Reservas Ativas</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Número</th>
          <th>Reservado Até (UTC)</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        {% for reservation in my_reservations %}
          <tr>
            <td>{{ reservation.number }}</td>
            <td>{{ reservation.reserved_until }}</td>
            <td>
              <form method="post" action="{{ url_for('release_reservation', number=reservation.number) }}">
                <button type="submit" class="btn">Liberar</button>
              </form>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="3">Nenhuma reserva ativa.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
{% endblock %}
